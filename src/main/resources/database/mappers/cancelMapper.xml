<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gndg.home.cancel.CancelDAO">

<insert id="addCancel" parameterType="CancelDTO">
<selectKey order="BEFORE" keyProperty="can_num" resultType="Long"> 
SELECT CANCEL_SEQ.NEXTVAL FROM DUAL
</selectKey>
INSERT INTO CANCEL VALUES (#{can_num}, #{merchant_uid}, sysdate, #{can_memo})
</insert>

<select id="getList" parameterType="OrderPager" resultMap="getListResult">
	SELECT * 
	FROM
	(SELECT ROWNUM R, C.*
	FROM
	(SELECT * FROM CANCEL C
	LEFT JOIN ORDERS O
	ON C.MERCHANT_UID = O.MERCHANT_UID
	WHERE 
		<choose>
			<when test="kind == 'merchant_uid'">O.MERCHANT_UID</when>
			<when test="kind == 'can_num'">C.CAN_NUM</when>
			<when test="kind == 'ord_status'">O.ORD_STATUS</when>
			<otherwise>O.USER_ID</otherwise>
		</choose>
		LIKE '%'||#{search}||'%' 
	<if  test= "searchdate1 != null">
		AND ORD_DATE BETWEEN #{searchdate1} AND TO_CHAR(#{searchdate2} + INTERVAL '1' DAY, 'YYYY-MM-DD')
	</if>	
	ORDER BY CAN_NUM DESC) C)
	WHERE R BETWEEN #{startRow} AND #{lastRow}
</select>

<resultMap type="OrdersDTO" id="getListResult">
	<id column="MERCHANT_UID" property="merchant_uid"/>
	<result column="USER_ID" property="user_id"/>
	<result column="ORD_TOTAL2" property="ord_total2"/>
	<result column="ORD_STATUS" property="ord_status"/>
	
	<collection property="cancelDTOs" javaType="List" ofType="CancelDTO">
		<id column="CAN_NUM" property="can_num"/>
		<result column="CAN_DATE" property="can_date"/>
	</collection>
</resultMap>



<select id="getListCount" parameterType="OrderPager" resultType="Long">
	SELECT COUNT(C.CAN_NUM) FROM CANCEL C
	LEFT JOIN ORDERS O
	ON C.MERCHANT_UID = O.MERCHANT_UID
	WHERE 
		<choose>
			<when test="kind == 'merchant_uid'">O.MERCHANT_UID</when>
			<when test="kind == 'can_num'">C.CAN_NUM</when>
			<when test="kind == 'ord_status'">O.ORD_STATUS</when>
			<otherwise>O.USER_ID</otherwise>
		</choose>
		LIKE '%'||#{search}||'%' 
	<if  test= "searchdate1 != null">
		AND ORD_DATE BETWEEN #{searchdate1} AND TO_CHAR(#{searchdate2} + INTERVAL '1' DAY, 'YYYY-MM-DD')
	</if>
</select>


	
<select id="getDetail" parameterType="CancelDTO" resultType="CancelDTO">
SELECT * 
FROM CANCEL C
LEFT JOIN ORDERS O
ON C.MERCHANT_UID = O.MERCHANT_UID
WHERE C.MERCHANT_UID=#{merchant_uid}
</select>


</mapper>
